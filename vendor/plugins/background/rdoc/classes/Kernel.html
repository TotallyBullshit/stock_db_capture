<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Module: Kernel</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Module</strong></td>
          <td class="class-name-in-header">Kernel</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../files/lib/core_ext/background_rb.html">
                lib/core_ext/background.rb
                </a>
        <br />
            </td>
        </tr>

        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">



   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000001">background</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000001" class="method-detail">
        <a name="M000001"></a>

        <div class="method-heading">
          <a href="#M000001" class="method-signature">
          <span class="method-name">background</span><span class="method-args">(*args, &amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Executes the given block in a <a href="Kernel.html#M000001">background</a>
task, or decorates a method to be executed in the <a
href="Kernel.html#M000001">background</a>.
</p>
<p>
There are two ways to use this method:
</p>
<h3>Decorate a method.</h3>
<p>
To decorate a class&#8217; method, the <a
href="Kernel.html#M000001">background</a> method must be called from inside
a class and the first argument must be a symbol, containing the name of the
method to decorate.
</p>
<pre>
   class FactorialClass
     def factorial(number)
       result = (1..number).inject(1) { |num, res| res * num }
       Logger.log(&quot;The result is #{result}&quot;)
     end

     # execute all calls to FactorialClass#factorial in the background
     background :factorial, :params =&gt; ['number']
   end
</pre>
<h3>Execute a block in the <a href="Kernel.html#M000001">background</a>.</h3>
<p>
To execute a block in the <a href="Kernel.html#M000001">background</a>,
simply call <a href="Kernel.html#M000001">Kernel#background</a> with the
block to execute. All local variables used in the block must be explicitely
supplied to the :locals option.
</p>
<pre>
   class User
     def delete_all_messages(move_to_trash)
       background :locals =&gt; { :trash =&gt; move_to_trash } do
         if trash
           self.messages.update_all &quot;folder = 'Trash'&quot;
         else
           self.messages.delete_all
         end
       end
     end
   end
</pre>
<p>
There are many possible strategies to run a block in a <a
href="Kernel.html#M000001">background</a> process, sometimes several inside
a single application. This is why there is an option to specify the <a
href="Kernel.html#M000001">background</a> handler for the particular block
to execute. For the case that the execution fails with the selected handler
(e.g. the <a href="Kernel.html#M000001">background</a> process
doesn&#8216;t respond), there is an option to specify one or more fallback
handlers. The handler and the fallback handlers are tried in order. On
every failure, an error is reported to the user through a configurable
error reporter. If no handler succeeds, the method returns nil, otherwise
the method returns a symbolized name of the first handler, that succeeded
in executing the block.
</p>
<h3>Choosing a handler</h3>
<p>
There are several ways to execute a task in the <a
href="Kernel.html#M000001">background</a>. To choose your particular
handler and optionally some fallback handlers, in case the <a
href="Kernel.html#M000001">background</a> process doesn&#8216;t respond,
use the :handler option.
</p>
<pre>
   background :handler =&gt; [:active_messaging, :disk] do
     # your code
   end
</pre>
<p>
To configure a handler, use a Hash instead of a Symbol like this:
</p>
<pre>
   background :handler =&gt; [{ :active_messaging =&gt; { :queue =&gt; :my_queue } }, :disk] do
     # your code, going over ActiveMessaging queue :my_queue
   end
</pre>
<h3>Options</h3>
<table>
<tr><td valign="top">handler:</td><td>The <a href="Kernel.html#M000001">background</a> handler to use. This
option is ignored when using the decoration method. If none is specified,
the Background::Config.default_handler is used. Available handlers are
:active_messaging, :in_process, :forget, :disk, and :test. This option can
also be an array, in which case all of the handlers are tried in order,
until one succeeds. Each element of the array may be a Symbol or a hash
with one element. If it is a hash, the key is the handler name, and the
value contains configuration options for the handler.

</td></tr>
<tr><td valign="top">params:</td><td>Parameter names of the method to decorate. These parameter names must match
the parameter names of the original method, that is decorated. This option
is ignored, when a block is given.

</td></tr>
<tr><td valign="top">locals:</td><td>A Hash containing name-value-pairs of local variables that need to be
accessible to the block when it is run in the <a
href="Kernel.html#M000001">background</a>. This option is ignored when a
method is decorated.

</td></tr>
<tr><td valign="top">reporter:</td><td>A reporter class that reports errors to the user. Available reporters are
:stdout, :silent, :exception_notification, and :test.

</td></tr>
</table>
<h3>Background Configurations</h3>
<p>
Instead of specifying the :handler: and :reporter: params directly, you can
also specify a configuration for your particular <a
href="Kernel.html#M000001">background</a> call, which is configured in
RAILS_ROOT/config/background.yml. This file has the following format:
</p>
<pre>
   test:
     queue:
       :handler: test
       :reporter: silent
   production
     queue:
       :handler:
       - :active_messaging:
           :queue: background
       :reporter: exception_notification
</pre>
<p>
You can also specify a default configuration like this:
</p>
<pre>
   default:
     :handler:
     - :in_process:
     - :disk:
</pre>
<h3>Precedence</h3>
<p>
For the handler and reporter options, the precedence is as follows, from
high to low:
</p>
<ul>
<li>method argument

</li>
<li>background.yml configuration, if supplied

</li>
<li>background.yml default configuration

</li>
<li>Background::Config.default_handler /
Background::Config.default_error_reporter

</li>
</ul>
<h3>Writing own handlers</h3>
<p>
Writing handlers is easy. A <a href="Kernel.html#M000001">background</a>
handler class must implement a self.handle method that accepts a hash
containing local variables as well as an options hash for the block to
execute. An error reporter must implement a self.report method that accepts
an exception object. Note that for most non-fallback handlers you need to
write a <a href="Kernel.html#M000001">background</a> task that accepts and
executes the block. See <a
href="Background/ActiveMessagingHandler.html">Background::ActiveMessagingHandler</a>
for an example on how to do that.
</p>
<h3>Things to note</h3>
<ul>
<li>Since it is not possible to serialize singleton objects, all objects are
dup&#8216;ed before serialization. This means that all singleton methods
get stripped away on serialization.

</li>
<li>Every class used in a <a href="Kernel.html#M000001">background</a> block or
method must be available in the <a
href="Kernel.html#M000001">background</a> process as well.

</li>
<li>Subject to the singleton restriction mentioned above, the self object is
correctly and automatically serialized and can be referenced in the block
using the self keyword.

</li>
</ul>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000001-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000001-source">
<pre>
     <span class="ruby-comment cmt"># File lib/core_ext/background.rb, line 131</span>
131:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">background</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
132:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Symbol</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Class</span>)
133:       <span class="ruby-identifier">method</span> = <span class="ruby-identifier">args</span>.<span class="ruby-identifier">shift</span>
134:       <span class="ruby-identifier">options</span> = <span class="ruby-identifier">args</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">||</span> {}
135:       <span class="ruby-identifier">params</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">:params</span>) <span class="ruby-operator">||</span> []
136:       <span class="ruby-comment cmt"># handler = [options.delete(:handler)].flatten</span>
137: 
138:       <span class="ruby-identifier">alias_method_chain</span> <span class="ruby-identifier">method</span>, <span class="ruby-identifier">:background</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">aliased_target</span>, <span class="ruby-identifier">punctuation</span><span class="ruby-operator">|</span>
139:         <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class_eval</span> <span class="ruby-node">%{
140:           def #{method}_with_background#{punctuation}(#{params.join(', ')})
141:             background(:locals =&gt; { #{params.collect {|p| &quot;:#{p} =&gt; #{p}&quot; }.join(', ')} }) do
142:               #{method}_without_background#{punctuation}(#{params.join(', ')})
143:             end
144:           end
145:         }</span>
146:       <span class="ruby-keyword kw">end</span>
147:     <span class="ruby-keyword kw">else</span>
148:       <span class="ruby-identifier">options</span> = <span class="ruby-identifier">args</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">||</span> {}
149:       <span class="ruby-identifier">locals</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">:locals</span>) <span class="ruby-operator">||</span> {}
150:       <span class="ruby-identifier">locals</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
151:         <span class="ruby-identifier">locals</span>[<span class="ruby-identifier">key</span>] = <span class="ruby-identifier">value</span>.<span class="ruby-identifier">dup</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-identifier">value</span>
152:       <span class="ruby-keyword kw">end</span>
153:       <span class="ruby-identifier">locals</span>[<span class="ruby-identifier">:self</span>] = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">dup</span>
154:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:config</span>]
155:         <span class="ruby-comment cmt">#puts options[:config]</span>
156:         <span class="ruby-identifier">config</span> = (<span class="ruby-constant">Background</span><span class="ruby-operator">::</span><span class="ruby-constant">Config</span>.<span class="ruby-identifier">load</span>(<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:config</span>].<span class="ruby-identifier">to_s</span>) <span class="ruby-operator">||</span> {})
157:       <span class="ruby-keyword kw">else</span>
158:         <span class="ruby-identifier">config</span> = {}
159:       <span class="ruby-keyword kw">end</span>
160:       <span class="ruby-comment cmt">#puts config.inspect</span>
161:       <span class="ruby-identifier">handler</span> = [<span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">:handler</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">config</span>[<span class="ruby-identifier">:handler</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">Background</span><span class="ruby-operator">::</span><span class="ruby-constant">Config</span>.<span class="ruby-identifier">default_handler</span>].<span class="ruby-identifier">flatten</span>
162:       <span class="ruby-identifier">reporter</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">:reporter</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">config</span>[<span class="ruby-identifier">:reporter</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">Background</span><span class="ruby-operator">::</span><span class="ruby-constant">Config</span>.<span class="ruby-identifier">default_error_reporter</span>
163:       
164:       <span class="ruby-identifier">handler</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">hand</span><span class="ruby-operator">|</span>
165:         <span class="ruby-identifier">options</span> = {}
166:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">hand</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">Hash</span>
167:           <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Malformed handler options Hash&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">hand</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">!=</span> <span class="ruby-value">1</span>
168:           <span class="ruby-identifier">options</span> = <span class="ruby-identifier">hand</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">first</span>
169:           <span class="ruby-identifier">hand</span> = <span class="ruby-identifier">hand</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">first</span>
170:         <span class="ruby-keyword kw">end</span>
171:         
172:         <span class="ruby-keyword kw">begin</span>
173:           <span class="ruby-node">&quot;Background::#{hand.to_s.camelize}Handler&quot;</span>.<span class="ruby-identifier">constantize</span>.<span class="ruby-identifier">handle</span>(<span class="ruby-identifier">locals</span>, <span class="ruby-identifier">options</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
174:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">hand</span>
175:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
176:           <span class="ruby-node">&quot;Background::#{reporter.to_s.camelize}ErrorReporter&quot;</span>.<span class="ruby-identifier">constantize</span>.<span class="ruby-identifier">report</span>(<span class="ruby-identifier">e</span>)
177:         <span class="ruby-keyword kw">end</span>
178:       <span class="ruby-keyword kw">end</span>
179:     <span class="ruby-keyword kw">end</span>
180:     <span class="ruby-keyword kw">nil</span>
181:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>