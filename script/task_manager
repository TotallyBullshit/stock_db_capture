#!/usr/bin/env ruby
# Copyright Â© Kevin P. Nolan 2009 All Rights Reserved.

require 'rubygems'
require 'ruby-debug'
require '../config/mini-environment'
require 'task/base'
require 'optparse'
require 'ostruct'

my_options = ARGV.inject([]) { |ary, el| ary << el if el == '--' || !ary.empty?; ary }.drop(1)

options = OpenStruct.new

if my_options.empty?
  options.server_count = 1
end

optparse = OptionParser.new do |opts|
  opts.default_argv = my_options
  opts.banner = "Usage task_manager start -- [options]"

  opts.on('-C', '--config FILE', String, "The task config file") do |config_file|
    options.config_file = config_file
  end

  options.server_count = 1
  opts.on('-s', '--servers NUMBER', Integer, "Fork NUMBER of task servers") do |s|
    options.server_count = p
  end

  opts.on('-h', '--help', 'Display this screen') do
    puts opts
    exit
  end
end

optparse.parse!
unless options.config_file
  puts 'config file is MANDITORY!'
else
  puts "Running #{options.server_count} processes"
  Task::Base.run(options.config_file, options.server_count)  if options.server_count > 0
end

# Local Variables:
# mode:ruby
# End:
